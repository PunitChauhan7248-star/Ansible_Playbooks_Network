---
- name: Configure Aruba CX Switch
  hosts: 10.10.0.29
  gather_facts: no
  collections:
    - arubanetworks.aoscx
    - ansible.netcommon

  vars:
    hostname: Aruba-CX-01

    access_vlan_id: 900
    trunk_vlan_id: 300

    access_ports:
      - 1/1/1
      - 1/1/2

    trunk_ports:
      - 1/1/11
      - 1/1/12

    snmp_community: "Prog-N@ida"
    ntp_server: "10.1.0.21"
    syslog_server: "10.1.0.62"

    new_username: "netadmin"
    new_password: "StrongPassword123"

    acl_name: "BLOCK_SSH"

  tasks:

  # ---------------- HOSTNAME ----------------

    - name: Set hostname
      arubanetworks.aoscx.aoscx_config:
        lines:
          - hostname {{ hostname }}

  # ---------------- VLAN CONFIGURATION ----------------

    - name: Create Access VLAN
      arubanetworks.aoscx.aoscx_config:
        parents: "vlan {{ access_vlan_id }}"
        lines:
          - name ACCESS_VLAN

    - name: Create Trunk VLAN
      arubanetworks.aoscx.aoscx_config:
        parents: "vlan {{ trunk_vlan_id }}"
        lines:
          - name TRUNK_VLAN

  # ---------------- ACCESS PORT CONFIG ----------------

    - name: Configure Access Ports
      arubanetworks.aoscx.aoscx_config:
        parents: "interface {{ item }}"
        lines:
          - no shutdown
          - vlan access {{ access_vlan_id }}
      loop: "{{ access_ports }}"

  # ---------------- TRUNK PORT CONFIG ----------------

    - name: Configure Trunk Ports
      arubanetworks.aoscx.aoscx_config:
        parents: "interface {{ item }}"
        lines:
          - no shutdown
          - vlan trunk native {{ access_vlan_id }}
          - vlan trunk allowed {{ trunk_vlan_id }}
      loop: "{{ trunk_ports }}"

  # ---------------- SNMP CONFIGURATION ----------------

    - name: Configure SNMP
      arubanetworks.aoscx.aoscx_config:
        lines:
          - snmp-server community {{ snmp_community }}

  # ---------------- NTP CONFIGURATION ----------------

    - name: Configure NTP
      arubanetworks.aoscx.aoscx_config:
        lines:
          - ntp server {{ ntp_server }}

  # ---------------- SYSLOG CONFIGURATION ----------------

    - name: Configure Syslog
      arubanetworks.aoscx.aoscx_config:
        lines:
          - logging {{ syslog_server }}

  # ---------------- AAA CONFIGURATION ----------------

    - name: Enable local authentication
      arubanetworks.aoscx.aoscx_config:
        lines:
          - aaa authentication login default local

  # ---------------- USER CONFIGURATION (AOS-CX 10.10 Syntax) ----------------

    - name: Create local admin user
      arubanetworks.aoscx.aoscx_config:
        lines:
          - username {{ new_username }} group administrators password plaintext {{ new_password }}

  # ---------------- ACL CONFIGURATION ----------------

    - name: Create ACL
      arubanetworks.aoscx.aoscx_config:
        parents: "access-list ip {{ acl_name }}"
        lines:
          - 10 deny tcp 10.2.0.0/24 any eq 22
          - 20 permit ip any any

    - name: Apply ACL to VLAN interface
      arubanetworks.aoscx.aoscx_config:
        parents: "interface vlan {{ access_vlan_id }}"
        lines:
          - ip access-group {{ acl_name }} in

  # ---------------- PORT SECURITY ----------------

    - name: Configure Port Security on Access Ports
      arubanetworks.aoscx.aoscx_config:
        parents: "interface {{ item }}"
        lines:
          - port-access port-security enable
          - port-access port-security maximum 2
          - port-access port-security violation restrict
      loop: "{{ access_ports }}"

  # ---------------- SAVE CONFIGURATION ----------------

    - name: Save configuration
      arubanetworks.aoscx.aoscx_command:
        commands:
          - write memory
